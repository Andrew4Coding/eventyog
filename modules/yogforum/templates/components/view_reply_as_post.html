{% extends "base.html" %}
{% load static %}
{% block content %}
<main class="w-full mb-20 px-4 sm:px-6 lg:px-8 mt-24">
    <div class="text-center"> 
        <h1 class="font-bold text-2xl sm:text-3xl md:text-4xl lg:text-5xl text-[#003FE2]">
            Replies to "
            {% if forum_post.reply_to %}
                {{ forum_post.reply_to.user.user.username }}
            {% else %}
                {{ forum_post.forum.user.user.username }}
            {% endif %} "
        </h1>
    </div>
    
    <!-- Reply acting as a post -->
    <div class="bg-gray-100 p-6 rounded-lg shadow-md mb-8 mt-4">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h2 class="text-xl font-semibold">Reply by {{ forum_post.user.user.username }}</h2>
                <p class="text-sm text-gray-500">{{ forum_post.content }}</p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Tombol Edit dan Delete -->
                {% if forum_post.user == request.user.userprofile %}
                <div class="flex space-x-2">
                    {% include "ds/button.html" with icon="fa fa-edit" text="Edit Post" class="w-fit h-fit" id="openModalButton" specify="open-modal-1" button_type="primary" %}
                    {% include "components/edit_modal.html" with modal_id="open-modal-1" modal_title="Edit Post" modal_label="modal-label" modal_class="w-[350px] max-w-[350px] lg:min-w-[1000px] h-fit max-h-[500px] lg:max-h-[700px]" %}
                    <form method="POST" action="{% url 'yogforum:delete_post' post_id=forum_post.id %}">
                        {% csrf_token %}
                        <button type="submit" class="bg-gray-200 text-gray-600 px-2 py-1 rounded hover:bg-gray-300">Delete</button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        <p class="text-gray-700 mb-4">{{ forum_post.created_at|date:"H:i" }} â€¢ {{ forum_post.created_at|date:"d/m/Y" }}</p>
            <!-- Likes and Dislikes Section -->
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500 flex items-center space-x-1">
                    <i class="fas fa-thumbs-up"></i> {{ forum_post.totalLike }}
                </span>
                <span class="text-sm text-gray-500 flex items-center space-x-1">
                    <i class="fas fa-thumbs-down"></i> {{ forum_post.totalDislike }}
                </span>
            </div>
        <div class="flex justify-end mt-4">
            {% include "ds/button.html" with icon="fa fa-reply" text="Reply to this Post" class="w-fit h-fit px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" id="openModalButton" specify="open-modal-2" button_type="primary" %}
        </div>    
    </div>

    <!-- Include modal for adding reply to this reply -->
    {% include "components/add_reply.html" with modal_id="open-modal-2" modal_title="Add a Reply" modal_class="w-[350px] max-w-[500px] lg:min-w-[1000px]" %}

    <script>
        document.getElementById('replyPostForm').addEventListener('submit', function(e) {
            e.preventDefault();  // Prevent form from submitting the default way

            var formData = new FormData(this);  // Collect the form data
            var url = this.action;  // Get the form's action (the URL)

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'  // Indicate it's an AJAX request
                }
            })
            .then(response => response.json())  // Parse the JSON response
            .then(data => {
                if (data.error) {
                    // Show the error message in a popup
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: data.error,
                    });
                } else {
                    // Show success message and reload the page
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: data.message,
                    }).then(() => {
                        location.reload();  // Reload the page to show the new reply
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    </script>

    <!-- Include SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Replies to this Reply -->
    <h3 class="font-bold text-lg mb-4">Replies to this Reply</h3>
    <div class="space-y-6">
        {% for reply in replies %}
            <!-- Include template for replies -->
            {% include "components/reply.html" with reply=reply level=1 %}
        {% endfor %}
    </div>

    <!-- Button Back to Main Forum -->
    <div class="mt-10">
        <a href="{% url 'yogforum:main' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded inline-flex items-center">
            <i class="fas fa-arrow-left mr-2"></i> Back to Home
        </a>
    </div>
</main>

{% endblock content %}