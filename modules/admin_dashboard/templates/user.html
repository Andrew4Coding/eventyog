{% extends "base.html" %}
{% include "toast.html" %}
{% load static %}
{% block content %}
    <main class="px-4 md:px-48 mt-32">
        <div class="flex flex-col gap-8">
            <div class="flex w-32 h-32 rounded-full shadow-sm overflow-hidden border-[1px] shadow-sm mx-auto md:mx-0">
                <img
                    src = 'http://res.cloudinary.com/mxgpapp/{{user_profile.profile_picture}}'
                    alt = '{{user_profile.name}}'
                    class="w-full h-full object-cover"
                />
            </div>
            <div class="flex flex-col gap-2 text-left">
                <div class="flex flex-col">
                    <h1 class="font-bold text-3xl">{{user_profile.name}}</h1>
                    <div class="flex gap-2 items-center">
                        <h3 class="text-md">{{user.username}}</h3>
                        -
                        <h3 class="text-md">{{user_profile.email}}</h3>
                    </div>
                </div>
                <p class="text-sm text-gray-500">{{user_profile.bio}}</p>
            </div>

            <div class="font-semibold flex flex-col gap-2">
                <h3>Event Types</h3>
                {% if user_profile.categories %}
                    <div class="flex flex-wrap gap-2 font-normal text-sm justify-start">
                        {% for category in user_profile.categories %}
                            <span class="px-3 py-1 bg-blue-200 text-blue-800 rounded-full">{{category}}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500">No event categories selected yet.</p>
                {% endif %}
            </div>
            
            {% if is_admin %}
            <div class="flex items-center gap-2">
                <button onclick="showEditModal()" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    <i class="fas fa-user-edit"></i>
                    Edit Profile
                </button>
                {% include "ds/button.html" with text="Delete Account" button_type="danger" icon="fas fa-user-minus" class="w-fit delete-account-button" %}
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg p-5 w-1/2">
            <h2 class="text-lg font-semibold mb-4">Edit User Profile</h2>
            <form action="{% url 'admin_dashboard:edit_user' user.id %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" name="name" value="{{user_profile.name}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" value="{{user_profile.email}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Bio</label>
                        <textarea name="bio" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">{{user_profile.bio}}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Profile Picture</label>
                        <input type="file" name="profile_picture" class="mt-1 block w-full">
                    </div>
                    <div class="mb-4">
                        <label for="categories" class="block text-sm font-medium text-gray-700">Preferable Event Categories</label>
                        <div class="relative">
                            <button type="button" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onclick="toggleDropdown(event)">Select Categories</button>
                            <div id="dropdown" class="absolute mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden">
                                <ul class="max-h-24 overflow-y-auto py-1" id='category-dropdown'>
                                </ul>
                            </div>
                        </div>
                        <div id="selected-categories" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button type="button" onclick="hideEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg p-5 w-1/3">
            <h2 class="text-lg font-semibold mb-4">Confirm Deletion</h2>
            <p>Are you sure you want to delete this user's account? This action cannot be undone.</p>
            <div class="flex justify-end mt-4">
                <button id="cancelButton" class="bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2">Cancel</button>
                <form action="{% url 'admin_dashboard:delete_user' user.id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded">Delete</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Define categories array
        const categories = [
            "Music",
            "Sports",
            "Arts and Culture",
            "Food and Drink",
            "Business and Networking",
            "Tech and Innovation",
            "Fashion",
            "Health and Wellness",
            "Education and Workshops",
            "Festivals",
            "Comedy and Entertainment",
            "Family and Kids",
            "Charity and Causes",
            "Nightlife",
            "Film and Media"
        ];
    
        // Get necessary DOM elements
        const dropdown = document.getElementById('dropdown');
        const categoryDropdown = document.getElementById('category-dropdown');
        const selectedCategoriesDiv = document.getElementById('selected-categories');
    
        // Toggle dropdown visibility
        function toggleDropdown(event) {
            event.stopPropagation();
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }
    
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdownButton = document.querySelector('button[onclick="toggleDropdown(event)"]');
            if (!dropdownButton.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
    
        // Update the display of selected categories
        function updateSelectedCategories() {
            selectedCategoriesDiv.innerHTML = '';
            const checkboxes = categoryDropdown.querySelectorAll('input[type="checkbox"]:checked');
            const form = document.querySelector('form');
            
            // Remove existing hidden inputs
            form.querySelectorAll('input[name="categories"]').forEach(input => input.remove());
            
            checkboxes.forEach(checkbox => {
                // Create chip
                const chip = document.createElement('div');
                chip.classList.add('bg-blue-100', 'text-blue-800', 'px-3', 'py-1', 'rounded-full', 'text-sm', 'flex', 'items-center');
                chip.textContent = checkbox.value;
                
                const removeButton = document.createElement('button');
                removeButton.classList.add('ml-2', 'text-blue-500', 'hover:text-blue-700');
                removeButton.innerHTML = '<i class="fas fa-times"></i>';
                removeButton.addEventListener('click', () => {
                    checkbox.checked = false;
                    updateSelectedCategories();
                });
                
                chip.appendChild(removeButton);
                selectedCategoriesDiv.appendChild(chip);
                
                // Create hidden input for form submission
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'categories';  // Changed from categories[] to categories
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
        }
    
        // Initialize dropdown with existing categories
        function initializeDropdown() {
            categoryDropdown.innerHTML = '';
            
            // Get current user categories from the page
            const currentCategories = [];
            {% if user_profile.categories %}
                {% for category in user_profile.categories %}
                    currentCategories.push("{{ category }}");
                {% endfor %}
            {% endif %}
            
            categories.forEach(category => {
                const li = document.createElement('li');
                li.classList.add('px-4', 'py-2', 'text-sm', 'text-gray-700', 'hover:bg-gray-100', 'cursor-pointer');
                
                const label = document.createElement('label');
                label.classList.add('flex', 'items-center', 'cursor-pointer', 'w-full', 'h-full');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = category;
                checkbox.classList.add('mr-2');
                
                // Check if this category is already selected
                if (currentCategories.includes(category)) {
                    checkbox.checked = true;
                }
                
                checkbox.addEventListener('change', updateSelectedCategories);
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(category));
                li.appendChild(label);
                categoryDropdown.appendChild(li);
            });
            
            updateSelectedCategories();
        }
    
        // Initialize everything when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeDropdown();
            
            // Toast messages handling
            {% if messages %}
                {% for message in messages %}
                    {% if message.tags %}
                        showToast("{{ message }}", "{{ message.tags }}");
                    {% else %}
                        showToast("{{ message }}", "info");
                    {% endif %}
                {% endfor %}
            {% endif %}
            
            const deleteButton = document.querySelector('.delete-account-button');
            const modal = document.getElementById('confirmationModal');
            const cancelButton = document.getElementById('cancelButton');
            
            if (deleteButton) {
                deleteButton.addEventListener('click', function (event) {
                    event.preventDefault();
                    modal.classList.remove('hidden');
                });
            }
            
            if (cancelButton) {
                cancelButton.addEventListener('click', function () {
                    modal.classList.add('hidden');
                });
            }
            
            if (modal) {
                modal.addEventListener('click', function (event) {
                    if (event.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
    
            const editModal = document.getElementById('editModal');
            if (editModal) {
                editModal.addEventListener('click', function (event) {
                    if (event.target === this) {
                        hideEditModal();
                    }
                });
            }
        });
    
        function showEditModal() {
            document.getElementById('editModal').classList.remove('hidden');
        }
    
        function hideEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
    </script>
    
{% endblock content %}